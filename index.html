<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de MemorizaciÃ³n de Frases</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=QqHIq0Z0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Aplicamos la fuente Inter a todo el cuerpo */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el texto seleccionado en el storytelling */
        .story-text.selected {
            background-color: #dbeafe; /* Un azul claro de Tailwind (blue-100) */
            transition: background-color 0.3s;
        }
        .story-text strong {
            color: #4f46e5; /* Color Ã­ndigo para resaltar (indigo-600) */
        }
        /* Estilos para la ventana modal */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Memorizar Frases</h1>
        </header>
        <div id="access-gate" class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Control de Acceso</h2>
            <p class="text-gray-500 mb-6">Por favor, introduce tu clave para continuar.</p>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="password" id="access-key-input" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Clave de acceso">
            </div>
            <button id="validate-key-btn" class="w-full mt-4 bg-gray-800 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-gray-900 transition">Validar</button>
            <p id="error-message" class="text-red-500 font-medium mt-4 hidden"></p>
        </div>
        <div id="start-container" class="text-center mb-6 hidden">
            </div>
        <main id="game-container" class="hidden">
            <section id="box-selectors" class="flex flex-wrap justify-center gap-2 mb-6">
                </section>
            <section id="card-container" class="bg-white p-4 sm:p-6 rounded-2xl shadow-xl min-h-[450px] flex items-center justify-center flex-col">
                </section>
        </main>
        <section id="final-review-container" class="hidden text-center">
            </section>

        <section id="storytelling-container" class="hidden text-center bg-white p-6 rounded-2xl shadow-xl">
             </section>

        <div id="review-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center transform scale-95">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Frase</h3>
                <div id="modal-image-container" class="w-full h-48 mb-4 rounded-lg overflow-hidden bg-gray-200 flex items-center justify-center text-6xl">
                    </div>
                <div class="space-y-2">
                    <p class="text-lg text-purple-700 font-semibold" id="modal-english-phrase"></p>
                    <p class="text-md text-blue-600 italic" id="modal-pronunciation"></p>
                    <p class="text-lg text-gray-600 mt-1" id="modal-spanish-phrase"></p>
                </div>
                <button id="modal-close-btn" class="mt-6 w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-red-700 transition">Cerrar</button>
            </div>
        </div>
        </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIABLES GLOBALES Y DATOS ---
            const csvData = `"english","spanish","pronunciation","emojis"
"What's up?","Â¿QuÃ© tal? / Â¿QuÃ© onda?","Guats-ap?","â“â¬†ï¸ğŸ“"
"How's it going?","Â¿CÃ³mo va todo?","Jaus-it-gÃ³-in?","â“ğŸš¶â€â™€ï¸â¡ï¸ğŸ”„"
"You alright? ","Â¿Todo bien?","Yu-ol-rÃ¡it?","ğŸ‘â“ğŸ˜Šâœ…"
"What have you been up to?","Â¿En quÃ© has andado?","GuÃ¡t-jav-iÃº-bin-ap-tu?","â“ğŸš¶â€â™‚ï¸â¡ï¸ğŸ’¡ğŸ¤”"
"Long time no see!","Â¡Tanto tiempo sin verte!","Long-tÃ¡im-no-sÃ­!","â³ğŸ‘€âŒğŸ‘‹ğŸ˜­"
"Sup? (Short for What's up?)","Â¿QuÃ© tal? (muy corto)","Sap?","â¬†ï¸â“âš¡"
"Hi, I don't think we've met. I'm .","Hola, creo que no nos conocemos. Soy .","JÃ¡i, Ã¡i-dont-zink-wiv-met. Ãim .","ğŸ‘‹ğŸ¤”ğŸ¤ğŸ‘¤â¡ï¸"
"How's your day going so far?","Â¿CÃ³mo va tu dÃ­a hasta ahora?","Jaus-yor-dÃ©i-gÃ³-in-so-far?","â˜€ï¸ğŸ—“ï¸â¡ï¸â“"
"Is this seat taken?","Â¿EstÃ¡ ocupado este asiento?","Is-dis-sÃ­t-tÃ©i-ken?","ğŸª‘ occupiedâ“"
"This is some crazy weather, huh?","Vaya clima, Â¿no?","Dis-is-som-crÃ©i-si-wÃ©der, ja?","ğŸŒ§ï¸â˜€ï¸ğŸŒ¬ï¸ğŸ¤¯â“"
"What do you do for a living?","Â¿A quÃ© te dedicas?","GuÃ¡t-du-iÃº-du-for-a-lÃ­-ving?","â“ğŸ’¼ğŸ’°ğŸ¢"
"So, what brings you here?","Y bien, Â¿quÃ© te trae por aquÃ­?","So, guÃ¡t-brings-iÃº-jir?","â“ğŸ“â¡ï¸ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°"
"I love your. Where did you get it?","Me encanta tu. Â¿DÃ³nde lo conseguiste?","Ai-lov-yor [shirt/bag]. WÃ©r-did-iÃº-guet-it?","ğŸ’–ğŸ‘•â“ğŸ›ï¸âœ¨"
"Are you from around here?","Â¿Eres de por aquÃ­?","Ar-iÃº-from-a-rÃ¡und-jir?","â“ğŸ“ğŸ ğŸ—ºï¸"
"Enjoying the event?","Â¿Disfrutando el evento?","En-yÃ³-ing-di-i-vÃ©nt?","ğŸ‰ğŸ¥³ğŸ¶â“"
"Has it been a busy week for you?","Â¿Has tenido una semana ocupada?","Jas-it-bin-a-bÃ­-si-wik-for-iÃº?","ğŸ—“ï¸ğŸâ“ğŸ˜…â°"
"How was your weekend?","Â¿QuÃ© tal tu fin de semana?","Jau-was-yor-wÃ­k-end?","â“ğŸ“…â¡ï¸ğŸ˜Œ"
"Hi , do you have a quick second?","Hola [Nombre], Â¿tienes un segundo?","JÃ¡i [Nombre], du-iÃº-jav-a-cuÃ­k-sÃ©-cond?","ğŸ‘‹â±ï¸â“ğŸƒâ€â™€ï¸ğŸ’¨"
"What are your thoughts on ?","Â¿QuÃ© opinas sobre  ?","GuÃ¡t-ar-yor-zots-on  ?","ğŸ¤”ğŸ’¬â“ğŸ’¡"
"I was hoping I could pick your brain about...","QuerÃ­a ver si podÃ­a consultarte sobre...","Ai-was-jÃ³-ping-ai-cud-pik-yor-brÃ©in-a-bÃ¡ut...","ğŸ§ ğŸ’¡â“ğŸ§ğŸ“š"
"Can I get you anything?","Â¿Te traigo algo?","Can-ai-guet-iÃº-Ã©-ni-zing?","ğŸ™‹â€â™€ï¸â“â˜•ğŸ›ï¸ğŸ"
"How about we grab a bite?","Â¿QuÃ© tal si comemos algo?","Jau-a-bÃ¡ut-wi-grab-a-bÃ¡it?","ğŸ”ğŸ•â“ğŸ¤ğŸ˜‹"
"I'm starving!","Â¡Me muero de hambre!","Ãim-stÃ¡r-ving!","ğŸ˜µâ€ğŸ’«ğŸ½ï¸ğŸ¤¤ğŸ˜©"
"I'm stuffed.","Estoy lleno/a.","Ãim-stÃ¡ft."," belly ğŸ¤°ğŸğŸ’¨"
"Can I try this on?","Â¿Me puedo probar esto?","Can-ai-trÃ¡i-dis-on?","ğŸ‘—ğŸ‘•â“ğŸš¶â€â™€ï¸ mirrors"
"How much is it?","Â¿CuÃ¡nto cuesta?","Jau-mach-is-it?","ğŸ’²â“ğŸ’°ğŸ’¸"
"I'm just Browse, thanks.","Solo estoy mirando, gracias.","Ãim-yost-brÃ¡u-sing, zanks.","ğŸ‘€ğŸ›ï¸ğŸš¶â€â™€ï¸âŒğŸ›’âœ‹"
"Where's the restroom?","Â¿DÃ³nde estÃ¡ el baÃ±o?","WÃ©rs-de-rest-rum?","ğŸš½â“ğŸ—ºï¸â¡ï¸"
"Excuse me, is this the way to...?","Disculpe, Â¿es este el camino a...?","Ex-kiÃºs-mi, is-dis-de-wÃ©i-tu...?","ğŸ—ºï¸â“ğŸš¶â€â™€ï¸â¡ï¸ğŸ“"
"Could you repeat that, please?","Â¿PodrÃ­as repetir eso, por favor?","Cud-iÃº-ri-pÃ­t-dat, pliis?","ğŸ—£ï¸ğŸ”„â“ğŸ‘‚ğŸ™"
"I'm running late.","Voy tarde.","Ãim-rÃ¡-ning-lÃ©it.","ğŸƒâ€â™€ï¸â°ğŸ’¨ğŸ˜¬âŒâ³"
"I'm just kidding!","Â¡Solo estoy bromeando!","Ãim-yost-kÃ­-ding!","ğŸ¤£ğŸ¤ªğŸ˜ğŸ¤¡"
"No worries.","No te preocupes.","No-wÃ³-rris.","ğŸ˜ŒğŸ‘ calm downğŸ§˜â€â™€ï¸"
"It's up to you.","Depende de ti.","Its-ap-tu-iÃº.","ğŸ¤·â€â™€ï¸ elecciÃ³n ğŸ²âš–ï¸"
"I'm on my way.","Estoy en camino.","Ãim-on-mÃ¡i-wÃ©i.","ğŸ“ğŸš—ğŸ’¨ caminoğŸš¶â€â™‚ï¸"
"Take care!","Â¡CuÃ­date!","TÃ©ik-keir!","ğŸ‘‹ğŸ’– seguridadğŸ›¡ï¸"
"Bless you!","Â¡Salud! (al estornudar)","Bles-iÃº!","ğŸ¤§ğŸ™ salÃºdâœ¨"
"Never mind.","No importa / OlvÃ­dalo.","NÃ©-ver-mÃ¡ind.","ğŸ’­â¡ï¸ğŸ—‘ï¸ forgetâœ‹"
"That's a good one!","Â¡Esa es buena!","Dats-a-gud-uan!","ğŸ‘ğŸ˜‚ genialğŸŒŸ"
"I'll be right back.","Ya vuelvo.","Ãil-bi-rÃ¡it-bak.","â†©ï¸ğŸƒâ€â™€ï¸ prontoâ±ï¸"
"I appreciate that.","Aprecio eso.","Ai-a-pri-shi-Ã©it-dat.","ğŸ™ğŸ’–âœ¨ğŸ™Œ"
"You got this!","Â¡TÃº puedes!","Yu-got-dis!","ğŸ’ªâœ¨ à¤œà¥€à¤¤ğŸ†ğŸŒŸ"
"Let me know.","AvÃ­same.","Let-mi-nou.","ğŸ“ğŸ“© infoğŸ“§"
"Sounds good.","Suena bien.","SÃ¡unds-gud.","ğŸ‘‚ğŸ‘ perfectoâœ…"
"I'm not feeling well.","No me siento bien.","Ãim-not-fÃ­-ling-wel.","ğŸ¤’ğŸ¤¢ malaiseğŸ˜·ğŸ˜”"
"What a small world!","Â¡QuÃ© mundo tan pequeÃ±o!","GuÃ¡t-a-smÃ³l-world!","ğŸŒğŸ¤ surprisedğŸ¤¯"
"Keep me posted.","Mantenme informado/a.","Kiip-mi-pÃ³us-ted.","ğŸ“¬â¡ï¸ğŸ“° updateğŸ”„"
"It's not a big deal.","No es para tanto.","Its-not-a-big-dÃ­il.","ğŸ¤ğŸ¤·â€â™€ï¸ insignificanteâŒâ›°ï¸"
"I can't complain.","No me puedo quejar.","Ai-cant-kom-plÃ©in.","ğŸ˜ŠğŸ‘ quejaâŒğŸš«"
"Figure it out.","ResuÃ©lvelo / AverÃ­gualo.","Fi-gur-it-Ã¡ut.","ğŸ’¡ğŸ” solucionarğŸ§©"`;

            const storytellingData = [
                {
                    story_en: "It was a rainy afternoon when Jake walked into the local coffee shop. He looked around and spotted an old friend by the window.\n\"<strong>What's up?</strong>\" he called out, waving.\nHis friend grinned, \"<strong>How's it going?</strong>\"\nJake laughed, \"<strong>You alright?</strong> You look like you haven't slept in days!\"\n\"Yeah, I'm good,\" his friend replied. \"<strong>What have you been up to?</strong>\"\nJake shrugged. \"<strong>Long time no see!</strong> I've been traveling a lot for work. <strong>Sup?</strong>\"\nThey both sat down and Jake noticed a stranger nearby. \"<strong>Hi, I don't think we've met.</strong> I'm Jake,\" he said, extending a hand.\nThe stranger smiled. \"Nice to meet you! <strong>How's your day going so far?</strong>\"\n\"Pretty good,\" Jake replied. He glanced at the empty seat next to the stranger. \"<strong>Is this seat taken?</strong>\"\n\"No, go ahead,\" the stranger answered.\nJust then, thunder rumbled outside. Jake laughed, \"<strong>This is some crazy weather, huh?</strong>\"\nEveryone nodded, glad to be inside, sharing stories and escaping the storm together.",
                    story_es: "Era una tarde lluviosa cuando Jake entrÃ³ a la cafeterÃ­a del barrio. MirÃ³ a su alrededor y vio a un viejo amigo junto a la ventana.\n-<strong>Â¿QuÃ© tal?</strong> -saludÃ³ con la mano.\nSu amigo sonriÃ³-<strong>Â¿CÃ³mo va todo?</strong>\nJake se riÃ³-<strong>Â¿Todo bien?</strong> Â¡Pareces no haber dormido en dÃ­as!\n-SÃ­, todo bien -respondiÃ³ su amigo. <strong>Â¿En quÃ© has andado?</strong>\nJake se encogiÃ³ de hombros-<strong>Â¡Tanto tiempo sin verte!</strong> He estado viajando mucho por trabajo. <strong>Â¿QuÃ© onda?</strong>\nAmbos se sentaron y Jake notÃ³ a un desconocido cerca de ellos-<strong>Hola, creo que no nos conocemos.</strong> Soy Jake-dijo, extendiendo la mano.\nEl desconocido sonriÃ³-Â¡Mucho gusto! <strong>Â¿CÃ³mo va tu dÃ­a hasta ahora?</strong>\n-Bastante bien -respondiÃ³ Jake. MirÃ³ el asiento vacÃ­o junto al desconocido-<strong>Â¿EstÃ¡ ocupado este asiento?</strong>\n-No, adelante -respondiÃ³ el desconocido.\nEn ese momento, un trueno retumbÃ³ afuera. Jake se riÃ³-<strong>Vaya clima, Â¿no?</strong>\nTodos asintieron, contentos de estar adentro, compartiendo historias y escapando de la tormenta."
                },
                {
                    story_en: "Later that evening, the coffee shop buzzed with new faces. Jake struck up a conversation with another guest.\n\"<strong>What do you do for a living?</strong>\" he asked.\n\"I'm a graphic designer,\" she replied. \"And you?\"\n\"I'm a teacher,\" Jake said. \"<strong>So, what brings you here?</strong>\"\nShe smiled, \"Just needed a break. By the way, <strong>I love your jacket. Where did you get it?</strong>\"\nJake beamed. \"Thanks! <strong>Are you from around here?</strong>\"\n\"Yeah, born and raised. <strong>Are you enjoying the event?</strong>\"\n\"Definitely,\" Jake replied. \"<strong>Has it been a busy week for you?</strong>\"\nShe nodded, \"Super busy. <strong>How was your weekend?</strong>\"\n\"Pretty relaxing, actually,\" Jake said. He spotted another friend across the room. \"<strong>Hi, Sarah, do you have a quick second?</strong>\"\nSarah joined them, and Jake turned to the group. \"<strong>What are your thoughts on the new art exhibit?</strong>\"\nThey all shared opinions, and Jake added, \"<strong>I was hoping I could pick your brain about</strong> creative ideas for my class.\"\nThe conversation flowed, and new friendships blossomed over coffee and curiosity.",
                    story_es: "MÃ¡s tarde esa noche, la cafeterÃ­a estaba llena de caras nuevas. Jake entablÃ³ conversaciÃ³n con otra invitada.\n-<strong>Â¿A quÃ© te dedicas?</strong> -preguntÃ³.\n-Soy diseÃ±adora grÃ¡fica -respondiÃ³ ella. Â¿Y tÃº?\n-Soy maestro -dijo Jake-. Y bien, <strong>Â¿quÃ© te trae por aquÃ­?</strong>\nElla sonriÃ³-Solo necesitaba un descanso. Por cierto, <strong>me encanta tu chaqueta. Â¿DÃ³nde la conseguiste?</strong>\nJake se iluminÃ³-Â¡Gracias! <strong>Â¿Eres de por aquÃ­?</strong>\n-SÃ­, nacÃ­ y crecÃ­ aquÃ­. <strong>Â¿Disfrutando el evento?</strong>\n-Sin duda -respondiÃ³ Jake-. <strong>Â¿Has tenido una semana ocupada?</strong>\nElla asintiÃ³-SÃºper ocupada. <strong>Â¿QuÃ© tal tu fin de semana?</strong>\n-Bastante relajado, la verdad -dijo Jake. Vio a otra amiga al fondo-<strong>Hola, Â¿tienes un segundo?</strong>\nElla se acercÃ³ y Jake preguntÃ³ al grupo-<strong>Â¿QuÃ© opinan sobre la nueva exposiciÃ³n de arte?</strong>\nTodos compartieron sus opiniones, y Jake aÃ±adiÃ³-<strong>QuerÃ­a ver si podÃ­a consultarte sobre</strong> ideas creativas para mi clase.\nLa conversaciÃ³n fluyÃ³ y nuevas amistades nacieron entre cafÃ© y curiosidad."
                },
                {
                    story_en: "The next morning, Jake was at the grocery store, still thinking about the art exhibit. He saw a friend looking confused in the produce aisle.\n\"Hey Mike, <strong>Can I get you anything?</strong> You look lost.\" Jake chuckled.\nMike sighed. \"Just trying to figure out dinner. <strong>How about we grab a bite?</strong> I'm <strong>starving!</strong>\"\nThey decided on pizza. After a few slices, Mike leaned back. \"Wow, <strong>I'm stuffed.</strong>\"\nLater, at a clothing store, Jake picked up a jacket. \"<strong>Can I try this on?</strong>\" he asked the assistant. \"And <strong>how much is it?</strong>\"\nThe assistant gave him the details. \"I'm just Browse, thanks,\" Jake said, putting it back. As they left, Mike asked, \"<strong>Where's the restroom?</strong>\"\nJake pointed him in the right direction. A tourist then approached Jake. \"<strong>Excuse me, is this the way to the museum?</strong>\" she asked.\nJake gave her directions. \"Oh, and <strong>could you repeat that, please?</strong>\" she added, pulling out her phone to type it down. Jake patiently repeated the directions, glad to help.",
                    story_es: "A la maÃ±ana siguiente, Jake estaba en el supermercado, todavÃ­a pensando en la exposiciÃ³n de arte. Vio a un amigo con cara de confusiÃ³n en la secciÃ³n de frutas y verduras.\n-Hola Mike, <strong>Â¿Te traigo algo?</strong> Te ves perdido-Jake se riÃ³ entre dientes.\nMike suspirÃ³. -Solo estoy tratando de decidir la cena. <strong>Â¿QuÃ© tal si comemos algo?</strong> Â¡Me <strong>muero de hambre!</strong>\nDecidieron ir por pizza. DespuÃ©s de unas cuantas rebanadas, Mike se recostÃ³. -Vaya, <strong>estoy lleno.</strong>\nMÃ¡s tarde, en una tienda de ropa, Jake tomÃ³ una chaqueta. -<strong>Â¿Me puedo probar esto?</strong> -le preguntÃ³ al dependiente-. Y <strong>Â¿cuÃ¡nto cuesta?</strong>\nEl dependiente le dio los detalles. -Solo estoy mirando, gracias-dijo Jake, volviendo a dejarla. Al salir, Mike preguntÃ³, -<strong>Â¿DÃ³nde estÃ¡ el baÃ±o?</strong>\nJake lo seÃ±alÃ³ en la direcciÃ³n correcta. Luego, una turista se acercÃ³ a Jake. -<strong>Disculpe, Â¿es este el camino al museo?</strong> -preguntÃ³.\nJake le dio las indicaciones. -Ah, y <strong>Â¿podrÃ­as repetir eso, por favor?</strong> -aÃ±adiÃ³ ella, sacando su telÃ©fono para anotarlo. Jake repitiÃ³ pacientemente las indicaciones, contento de ayudar."
                },
                {
                    story_en: "Later that day, Jake got a call. \"Hey, <strong>I'm running late!</strong>\" his friend Sarah exclaimed. \"<strong>I'm just kidding!</strong> Gotcha!\"\nJake laughed. \"Almost believed you! <strong>No worries.</strong> I was just about to head out. What do you want to do tonight? <strong>It's up to you.</strong>\"\nSarah suggested a movie. \"Great! <strong>I'm on my way,</strong>\" Jake said. As he hung up, he realized he forgot his keys. \"Oh, <strong>take care!</strong>\" he muttered to himself as he rushed back.\nOn the way, someone sneezed loudly. \"<strong>Bless you!</strong>\" Jake said automatically. He bumped into another friend. \"Oh, <strong>never mind,</strong>\" he said, realizing it wasn't who he thought.\nHis friend told him a funny story. \"<strong>That's a good one!</strong>\" Jake chuckled. \"Anyway, <strong>I'll be right back.</strong> I need to grab something from my car.\"",
                    story_es: "MÃ¡s tarde ese dÃ­a, Jake recibiÃ³ una llamada. -Â¡Oye, <strong>voy tarde!</strong> -exclamÃ³ su amiga Sarah-. Â¡Solo estoy bromeando! Â¡Te pillÃ©!\nJake se riÃ³. -Â¡Casi te creo! <strong>No te preocupes.</strong> Estaba a punto de salir. Â¿QuÃ© quieres hacer esta noche? <strong>Depende de ti.</strong>\nSarah sugiriÃ³ una pelÃ­cula. -Â¡Genial! <strong>Estoy en camino,</strong> -dijo Jake. Al colgar, se dio cuenta de que habÃ­a olvidado sus llaves. -Ay, Â¡cuÃ­date! -murmurÃ³ para sÃ­ mismo mientras regresaba corriendo.\nEn el camino, alguien estornudÃ³ ruidosamente. -Â¡Salud! -dijo Jake automÃ¡ticamente. ChocÃ³ con otro amigo. -Ah, <strong>no importa,</strong> -dijo, dÃ¡ndose cuenta de que no era quien pensaba.\nSu amigo le contÃ³ una historia divertida. -Â¡Esa es buena! -Jake se riÃ³ entre dientes. -De todos modos, <strong>ya vuelvo.</strong> Necesito coger algo de mi coche."
                },
                {
                    story_en: "The next morning, Jake was reflecting on his busy week. He received an email from a colleague, praising his recent project. \"<strong>I appreciate that,</strong>\" he thought, feeling proud. His mentor had always told him, \"<strong>You got this!</strong>\" whenever he felt overwhelmed.\nHe decided to plan a new workshop. \"Let me know if you have any ideas,\" he emailed his team. A response came quickly: \"<strong>Sounds good.</strong>\"\nLater, Jake felt a bit under the weather. \"<strong>I'm not feeling well,</strong>\" he told his wife. Despite this, he ran into an old university friend at the park. \"<strong>What a small world!</strong>\" he exclaimed. They chatted briefly, promising to catch up properly. \"<strong>Keep me posted</strong> on your new venture!\" Jake called out.\nHe thought about some minor issues with his computer. \"<strong>It's not a big deal,</strong>\" he decided, he'd fix it later. Overall, he considered his week. \"<strong>I can't complain,</strong>\" he smiled. He just needed to \"<strong>figure it out</strong>\" one step at a time.",
                    story_es: "A la maÃ±ana siguiente, Jake reflexionaba sobre su ajetreada semana. RecibiÃ³ un correo electrÃ³nico de un colega, elogiando su proyecto reciente. -<strong>Aprecio eso,</strong> -pensÃ³, sintiÃ©ndose orgulloso. Su mentor siempre le habÃ­a dicho, -Â¡TÃº puedes! -cada vez que se sentÃ­a abrumado.\nDecidiÃ³ planear un nuevo taller. -AvÃ­same si tienes alguna idea-enviÃ³ un correo electrÃ³nico a su equipo. Una respuesta llegÃ³ rÃ¡pidamente: -<strong>Suena bien.</strong>\nMÃ¡s tarde, Jake se sintiÃ³ un poco indispuesto. -<strong>No me siento bien,</strong> -le dijo a su esposa. A pesar de esto, se encontrÃ³ con un viejo amigo de la universidad en el parque. -Â¡QuÃ© mundo tan pequeÃ±o! -exclamÃ³. Charlaron brevemente, prometiendo ponerse al dÃ­a correctamente. -Â¡Mantenme informado sobre tu nueva empresa! -gritÃ³ Jake.\nPensÃ³ en algunos problemas menores con su computadora. -<strong>No es para tanto,</strong> -decidiÃ³, lo arreglarÃ­a mÃ¡s tarde. En general, considerÃ³ su semana. -<strong>No me puedo quejar,</strong> -sonriÃ³. Solo necesitaba -<strong>resolverlo</strong>- un paso a la vez."
                }
            ];

            const accessKeys = { "123": "2025-07-20", "456": "2025-07-30" };
            const accessGate = document.getElementById('access-gate');
            const accessKeyInput = document.getElementById('access-key-input');
            const errorMessage = document.getElementById('error-message');
            const startContainer = document.getElementById('start-container');
            const gameContainer = document.getElementById('game-container');
            const finalReviewContainer = document.getElementById('final-review-container');
            const storytellingContainer = document.getElementById('storytelling-container');
            const reviewModal = document.getElementById('review-modal');
            
            let loginAttempts = 0;
            const MAX_ATTEMPTS = 3;
            let allPhrases = [];
            let phrases = [];
            let boxes = [];
            let currentBoxIndex = 0;
            let currentBatchIndex = 0;
            let gameHasBeenPlayed = false;

            let utterance = null;
            if ('speechSynthesis' in window) {
                utterance = new SpeechSynthesisUtterance();
                utterance.onend = () => console.log('ReproducciÃ³n completada.');
                utterance.onerror = (error) => {
                    console.error('Error con speechSynthesis, usando fallback:', error);
                };
            }

            stopAllAudio();

            function parseCSV(data) {
                const lines = data.trim().split('\n').slice(1);
                return lines.map(line => {
                    const parts = line.match(/^"(.*?)","(.*?)"(?:,"(.*?)"|),"(.*)"$/);
                    if (parts && parts.length === 5) {
                        const english = parts[1];
                        const spanish = parts[2];
                        const pronunciation = parts[3];
                        const emojis = parts[4]; 

                        return { english, spanish, pronunciation, emojis }; // Eliminamos imageUrl
                    }
                    return null;
                }).filter(p => p !== null && p.english && p.spanish && p.pronunciation && p.emojis);
            }
            allPhrases = parseCSV(csvData);

            function validateAccessKey() {
                const key = accessKeyInput.value.trim();
                errorMessage.classList.add('hidden');
                if (!accessKeys[key]) {
                    loginAttempts++;
                    errorMessage.textContent = `Clave invÃ¡lida. Te quedan ${MAX_ATTEMPTS - loginAttempts} intento(s).`;
                    errorMessage.classList.remove('hidden');
                } else {
                    const expirationDateString = accessKeys[key];
                    const expirationDate = new Date(expirationDateString + "T23:59:59");
                    const today = new Date();
                    if (today > expirationDate) {
                        loginAttempts++;
                        const formattedDate = new Date(expirationDate).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
                        errorMessage.textContent = `La clave caducÃ³ el ${formattedDate}. Te quedan ${MAX_ATTEMPTS - loginAttempts} intento(s).`;
                        errorMessage.classList.remove('hidden');
                    } else {
                        loginAttempts = 0;
                        showBatchSelectionScreen();
                        return;
                    }
                }
                if (loginAttempts >= MAX_ATTEMPTS) {
                    errorMessage.textContent = "Has excedido el nÃºmero de intentos. La aplicaciÃ³n se ha bloqueado.";
                    accessKeyInput.disabled = true;
                    document.getElementById('validate-key-btn').disabled = true;
                    document.getElementById('validate-key-btn').classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }
            
            function showBatchSelectionScreen() {
                stopAllAudio();
                accessGate.classList.add('hidden');
                gameContainer.classList.add('hidden');
                finalReviewContainer.classList.add('hidden');
                storytellingContainer.classList.add('hidden');
                startContainer.innerHTML = '';
                const infoText = document.createElement('p');
                infoText.className = 'text-gray-600 mb-6';
                infoText.textContent = 'Â¡Acceso concedido! Elige un grupo de frases para comenzar.';
                startContainer.appendChild(infoText);
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex flex-col sm:flex-row sm:justify-center gap-4';
                const batchSize = 10;
                const numBatches = Math.ceil(allPhrases.length / batchSize);
                for (let i = 0; i < numBatches; i++) {
                    const start = i * batchSize + 1;
                    const end = Math.min((i + 1) * batchSize, allPhrases.length);
                    const batchBtn = document.createElement('button');
                    batchBtn.textContent = `Frases ${start} - ${end}`;
                    batchBtn.className = 'bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300';
                    batchBtn.onclick = () => startGameWithBatch(i);
                    buttonContainer.appendChild(batchBtn);
                }
                
                const reviewBtn = document.createElement('button');
                reviewBtn.textContent = 'Repaso General';
                if (gameHasBeenPlayed) {
                    reviewBtn.className = 'bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300';
                    reviewBtn.onclick = startReview;
                } else {
                    reviewBtn.className = 'bg-green-300 text-white font-bold py-3 px-8 rounded-lg shadow-inner cursor-not-allowed';
                    reviewBtn.disabled = true;
                    reviewBtn.title = "Completa un bloque de frases para activar esta opciÃ³n";
                }
                buttonContainer.appendChild(reviewBtn);

                startContainer.appendChild(buttonContainer);
                startContainer.classList.remove('hidden');
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function initializeGameState() {
                shuffleArray(phrases);
                boxes = Array.from({ length: 7 }, () => []);
                boxes[0] = [...phrases];
                currentBoxIndex = 0;
            }

            function stopAllAudio() {
                if (typeof responsiveVoice !== 'undefined') {
                    responsiveVoice.cancel();
                }
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            }
            
            function speak(text, lang, rate = 0.8) {
                stopAllAudio();
                const cleanText = text.replace(/<strong>|<\/strong>/g, '');
                if (speechSynthesis && utterance) {
                    utterance.text = cleanText;
                    utterance.lang = lang;
                    utterance.rate = rate;
                    utterance.onerror = (event) => {
                        console.error('Error con speechSynthesis, usando fallback:', event);
                        useResponsiveVoiceFallback(cleanText, lang, rate);
                    };
                    speechSynthesis.speak(utterance);
                } else {
                    useResponsiveVoiceFallback(cleanText, lang, rate);
                }
            }

            function useResponsiveVoiceFallback(text, lang, rate) {
                const voiceMap = { 'en-US': 'US English Female', 'es-ES': 'Spanish Female' };
                const voice = voiceMap[lang] || 'US English Female';
                responsiveVoice.speak(text, voice, {
                    rate: rate,
                    onend: () => console.log('ReproducciÃ³n completada con ResponsiveVoice.'),
                    onerror: (error) => console.error('Error al reproducir audio con ResponsiveVoice:', error)
                });
            }

            function playAll(lang, rate) {
                stopAllAudio();
                const separator = '; ';
                const textToPlay = (lang === 'en-US' ? phrases.map(p => p.english) : phrases.map(p => p.spanish)).join(separator);
                speak(textToPlay, lang, rate);
            }

            function startGameWithBatch(batchIndex) {
                stopAllAudio();
                gameHasBeenPlayed = true;
                currentBatchIndex = batchIndex;
                const batchSize = 10;
                const startIndex = batchIndex * batchSize;
                phrases = allPhrases.slice(startIndex, startIndex + batchSize);
                startContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                finalReviewContainer.classList.add('hidden');
                storytellingContainer.classList.add('hidden');
                initializeGameState();
                renderUI();
            }

            function startReview() {
                stopAllAudio();
                phrases = [...allPhrases];
                currentBatchIndex = 0; // Se puede revisar el storytelling de cualquier bloque
                startContainer.classList.add('hidden');
                gameContainer.classList.add('hidden');
                storytellingContainer.classList.add('hidden');
                displayFinalReview(false);
            }

            function finishGame() {
                stopAllAudio();
                startContainer.classList.add('hidden');
                gameContainer.classList.add('hidden');
                finalReviewContainer.classList.add('hidden');
                storytellingContainer.classList.add('hidden');
                accessGate.classList.remove('hidden');
                accessKeyInput.value = '';
                loginAttempts = 0;
                accessKeyInput.disabled = false;
                document.getElementById('validate-key-btn').disabled = false;
                document.getElementById('validate-key-btn').classList.remove('bg-gray-400', 'cursor-not-allowed');
                gameHasBeenPlayed = false;
                setupEventListeners();
            }
            
            function renderUI() {
                const boxContainer = document.getElementById('box-selectors');
                if (boxContainer) {
                    boxContainer.innerHTML = boxes.map((box, index) =>
                        `<button data-action="select-box" data-box-index="${index}" class="px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 ${index === currentBoxIndex ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'}">Caja ${index + 1} (${box.length})</button>`
                    ).join('');
                }
                displayCard();
            }

            function displayCard() {
                const cardContainer = document.getElementById('card-container');
                if (!cardContainer) return;
                cardContainer.innerHTML = '';
                const currentBox = boxes[currentBoxIndex];
                if (currentBox.length === 0) {
                    cardContainer.innerHTML = `<div class="text-center text-gray-500"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4a2 2 0 002-2V7m-4 12h.01M12 3h.01M4 12h.01M20 12h.01M4 7h.01M4 17h.01M20 7h.01M20 17h.01" /></svg><h2 class="mt-2 text-xl font-semibold">Caja VacÃ­a</h2><p class="mt-1 text-sm">No hay frases en esta caja. Si todas las frases estÃ¡n en la caja 7, ve a "Repaso Final".</p></div>`;
                     if (boxes.length > 6 && boxes[6].length === phrases.length) {
                        cardContainer.innerHTML += `<button id="go-to-review-btn" class="mt-4 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition">Ir a Repaso Final</button>`;
                    }
                    return;
                }
                const cardData = currentBox[0];
                cardContainer.innerHTML = `
                    <div class="w-full animate-fade-in flex flex-col items-center">
                        <div class="w-full max-w-md h-64 mb-4 rounded-lg overflow-hidden shadow-lg bg-gray-200 flex items-center justify-center text-6xl">
                            ${cardData.emojis}
                        </div>
                        <div id="reveal-area" class="w-full max-w-md min-h-[60px] bg-gray-100 flex items-center justify-center text-center p-3 rounded-lg mb-4 text-lg font-semibold text-gray-800"></div>
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 w-full max-w-md mb-4">
                            <button data-action="reveal-en" class="col-span-1 sm:col-span-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md hover:bg-gray-50 transition">InglÃ©s</button>
                            <button data-action="reveal-es" class="col-span-1 sm:col-span-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md hover:bg-gray-50 transition">EspaÃ±ol</button>
                            <button data-action="reveal-pr" class="col-span-1 sm:col-span-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md hover:bg-gray-50 transition">Pron.</button>
                            <button data-action="speak-en" title="Pronunciar en InglÃ©s" class="col-span-1 sm:col-span-1 bg-purple-600 text-white p-2 rounded-md hover:bg-purple-700 transition flex justify-center items-center"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z"></path></svg></button>
                            <button data-action="speak-es" title="Pronunciar en EspaÃ±ol" class="col-span-1 sm:col-span-1 bg-gray-800 text-white p-2 rounded-md hover:bg-gray-900 transition flex justify-center items-center"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z"></path></svg></button>
                        </div>
                        <div class="flex gap-4 w-full max-w-md">
                            <button data-action="box-1" class="w-1/2 bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition shadow">A la Caja 1</button>
                            <button data-action="next-box" class="w-1/2 bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition shadow">Siguiente Caja</button>
                        </div>
                    </div>`;
            }

            // --- MODIFICADO: FunciÃ³n displayFinalReview ---
            function displayFinalReview(isCompleted = false) {
                stopAllAudio();
                gameContainer.classList.add('hidden');
                storytellingContainer.classList.add('hidden');
                finalReviewContainer.classList.remove('hidden');

                const title = isCompleted ? "Â¡Felicidades! Has completado el set." : "Repaso General";
                finalReviewContainer.innerHTML = `
                    <h2 class="text-3xl font-bold text-green-600 mb-2">${title}</h2>
                     <p class="text-gray-600 mb-8">AquÃ­ estÃ¡n todas las frases que has estudiado. <strong>Haz clic en el icono para ver los detalles.</strong></p>
                    <div id="review-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-8"></div>
                    <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-4 max-w-4xl mx-auto">
                        <div class="flex flex-col gap-4">
                             <button id="storytelling-btn" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-yellow-600 transition">Ver Storytelling</button>
                            <button id="reset-game-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition">Elegir otro bloque</button>
                        </div>
                         <div class="flex flex-col gap-4">
                            <button id="play-all-en-normal-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-purple-700 transition">InglÃ©s (Normal)</button>
                            <button id="play-all-en-slow-btn" class="w-full bg-purple-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-purple-900 transition">InglÃ©s (Lento)</button>
                        </div>
                         <div class="flex flex-col gap-4">
                            <button id="play-all-es-normal-btn" class="w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-gray-800 transition">EspaÃ±ol (Normal)</button>
                            <button id="play-all-es-slow-btn" class="w-full bg-gray-900 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-black transition">EspaÃ±ol (Lento)</button>
                        </div>
                    </div>
                     <button id="finish-game-btn" class="mt-6 bg-red-600 text-white font-bold py-2 px-8 rounded-lg shadow-lg hover:bg-red-700 transition">Terminar SesiÃ³n</button>
                `;

                // --- MODIFICADO: Generar grid con data attributes para el modal, incluyendo pronunciaciÃ³n ---
                document.getElementById('review-grid').innerHTML = phrases.map(phrase =>
                    `<div class="relative aspect-square rounded-lg overflow-hidden shadow-md transition-transform hover:scale-105 cursor-pointer bg-gray-200 flex items-center justify-center text-5xl" 
                         data-english="${phrase.english}" 
                         data-spanish="${phrase.spanish}"
                         data-pronunciation="${phrase.pronunciation}"
                         data-emojis="${phrase.emojis}">
                        ${phrase.emojis}
                    </div>`
                ).join('');
                setupEventListeners();
            }
            
            // --- MODIFICADO: FunciÃ³n para mostrar el modal con pronunciaciÃ³n y emojis ---
            function showReviewModal(english, spanish, pronunciation, emojis) {
                document.getElementById('modal-english-phrase').textContent = english;
                document.getElementById('modal-spanish-phrase').textContent = spanish;
                document.getElementById('modal-pronunciation').textContent = pronunciation;
                
                const modalImageContainer = document.getElementById('modal-image-container');
                modalImageContainer.innerHTML = `<span class="text-6xl">${emojis}</span>`; // Solo emojis

                reviewModal.classList.remove('hidden');
                setTimeout(() => { 
                    reviewModal.classList.remove('opacity-0');
                    reviewModal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }

            function hideReviewModal() {
                reviewModal.classList.add('opacity-0');
                reviewModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    reviewModal.classList.add('hidden');
                }, 300); 
            }

            function displayStorytelling() {
                stopAllAudio();
                finalReviewContainer.classList.add('hidden');
                storytellingContainer.classList.remove('hidden');

                const story = storytellingData[currentBatchIndex];
                const storyEnArray = story.story_en.split('\n');
                const storyEsArray = story.story_es.split('\n');

                storytellingContainer.innerHTML = `
                    <h2 class="text-3xl font-bold text-yellow-600 mb-6">Storytelling</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-purple-700">English Story</h3>
                            <div id="story-en-container" class="space-y-2 leading-relaxed">
                                ${storyEnArray.map((p, i) => `<p class="story-text p-2 rounded-md cursor-pointer" data-lang="en" data-index="${i}">${p}</p>`).join('')}
                            </div>
                            <button id="play-story-en" class="mt-4 w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-purple-700 transition">Reproducir en InglÃ©s</button>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-gray-800">Historia en EspaÃ±ol</h3>
                            <div id="story-es-container" class="space-y-2 leading-relaxed">
                                 ${storyEsArray.map((p, i) => `<p class="story-text p-2 rounded-md cursor-pointer" data-lang="es" data-index="${i}">${p}</p>`).join('')}
                            </div>
                            <button id="play-story-es" class="mt-4 w-full bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-gray-900 transition">Reproducir en EspaÃ±ol</button>
                        </div>
                    </div>
                    <button id="back-to-review-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition">Volver al Repaso</button>
                `;
                setupEventListeners();
            }

            function highlightText(lang, index) {
                document.querySelectorAll('.story-text.selected').forEach(el => el.classList.remove('selected'));
                const enEl = document.querySelector(`.story-text[data-lang="en"][data-index="${index}"]`);
                const esEl = document.querySelector(`.story-text[data-lang="es"][data-index="${index}"]`);
                if (enEl) enEl.classList.add('selected');
                if (esEl) esEl.classList.add('selected');
            }
            
            function moveCard(advance) {
                const cardToMove = boxes[currentBoxIndex].shift();
                if (!cardToMove) return;
                const nextBoxIndex = currentBoxIndex === 0 ? Math.min(1, boxes.length - 1) : Math.min(currentBoxIndex + 1, boxes.length - 1);
                
                // Si la caja actual se vacÃ­a y no es la Ãºltima, avanza a la siguiente caja automÃ¡ticamente.
                if (boxes[currentBoxIndex].length === 0 && currentBoxIndex < boxes.length -1) {
                    currentBoxIndex = nextBoxIndex;
                }
                
                if (advance) {
                    boxes[nextBoxIndex].push(cardToMove);
                } else {
                    boxes[0].push(cardToMove);
                }
                
                // Si todas las frases estÃ¡n en la Ãºltima caja, muestra la revisiÃ³n final.
                if (boxes.length > 6 && boxes[6].length === phrases.length) {
                    displayFinalReview(true);
                } else {
                    renderUI();
                }
            }
            
            function setupEventListeners() {
                document.getElementById('validate-key-btn')?.addEventListener('click', validateAccessKey);
                document.getElementById('reset-game-btn')?.addEventListener('click', showBatchSelectionScreen);
                document.getElementById('finish-game-btn')?.addEventListener('click', finishGame);
                document.getElementById('go-to-review-btn')?.addEventListener('click', () => displayFinalReview(true));

                document.getElementById('play-all-en-normal-btn')?.addEventListener('click', () => playAll('en-US', 0.8));
                document.getElementById('play-all-en-slow-btn')?.addEventListener('click', () => playAll('en-US', 0.5));
                document.getElementById('play-all-es-normal-btn')?.addEventListener('click', () => playAll('es-ES', 0.8));
                document.getElementById('play-all-es-slow-btn')?.addEventListener('click', () => playAll('es-ES', 0.5));
                document.getElementById('storytelling-btn')?.addEventListener('click', displayStorytelling);

                document.getElementById('back-to-review-btn')?.addEventListener('click', () => displayFinalReview(boxes.length > 6 && boxes[6].length === phrases.length));
                document.getElementById('play-story-en')?.addEventListener('click', () => {
                    const storyText = storytellingData[currentBatchIndex].story_en;
                    speak(storyText, 'en-US', 0.6);
                });
                document.getElementById('play-story-es')?.addEventListener('click', () => {
                    const storyText = storytellingData[currentBatchIndex].story_es;
                    speak(storyText, 'es-ES', 0.6);
                });

                document.getElementById('story-en-container')?.addEventListener('click', (e) => {
                     const target = e.target.closest('.story-text');
                    if (target) highlightText(target.dataset.lang, target.dataset.index);
                });
                 document.getElementById('story-es-container')?.addEventListener('click', (e) => {
                     const target = e.target.closest('.story-text');
                    if (target) highlightText(target.dataset.lang, target.dataset.index);
                });

                const boxContainer = document.getElementById('box-selectors');
                if (boxContainer) boxContainer.onclick = (e) => {
                    const target = e.target.closest('button[data-action="select-box"]');
                    if (target) {
                        const newIndex = parseInt(target.dataset.boxIndex, 10);
                        if (newIndex !== currentBoxIndex) {
                            currentBoxIndex = newIndex;
                            renderUI();
                        }
                    }
                };

                const cardContainer = document.getElementById('card-container');
                if (cardContainer) cardContainer.onclick = (e) => {
                    const target = e.target.closest('button');
                    if (!target || !target.dataset.action) return;
                    const action = target.dataset.action;
                    const card = boxes[currentBoxIndex]?.[0];
                    if (!card) return;
                    switch (action) {
                        case 'reveal-en': document.getElementById('reveal-area').textContent = card.english; break;
                        case 'reveal-es': document.getElementById('reveal-area').textContent = card.spanish; break;
                        case 'reveal-pr': document.getElementById('reveal-area').textContent = card.pronunciation; break;
                        case 'speak-en': speak(card.english, 'en-US'); break;
                        case 'speak-es': speak(card.spanish, 'es-ES'); break;
                        case 'next-box': moveCard(true); break;
                        case 'box-1': moveCard(false); break;
                    }
                };
                
                // --- MODIFICADO: Event listener para la grid, ahora pasa la pronunciaciÃ³n ---
                document.getElementById('review-grid')?.addEventListener('click', (e) => {
                    const target = e.target.closest('div[data-english]');
                    if (target) {
                        showReviewModal(
                            target.dataset.english, 
                            target.dataset.spanish, 
                            target.dataset.pronunciation, 
                            target.dataset.emojis // Pasar los emojis al modal
                        );
                    }
                });
                
                document.getElementById('modal-close-btn')?.addEventListener('click', hideReviewModal);
                reviewModal?.addEventListener('click', (e) => {
                    if (e.target === reviewModal) {
                        hideReviewModal();
                    }
                });

                const keyInput = document.getElementById('access-key-input');
                if (keyInput) {
                    keyInput.onkeydown = (e) => { if (e.key === 'Enter') validateAccessKey(); };
                    keyInput.oninput = () => errorMessage.classList.add('hidden');
                }
            }

            // InicializaciÃ³n
            setupEventListeners();
        });
    </script>
</body>
</html>