<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad de Aprendizaje Intensivo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados para la aplicación */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para las pestañas de navegación */
        .tab-btn {
            @apply py-3 px-2 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 focus:outline-none transition-all duration-300;
        }

        .active-tab {
            @apply border-sky-500 text-sky-500;
        }

        /* Estilos para el elemento que se está arrastrando */
        .dragging {
            opacity: 0.5;
            transform: scale(1.1);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Estilo para la zona de destino cuando se arrastra un elemento sobre ella */
        #drop-zone.drag-over {
            background-color: #e0f2fe; /* bg-sky-100 */
            border-color: #38bdf8;   /* border-sky-400 */
        }

        /* Animación para feedback de respuesta correcta */
        @keyframes correct-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .correct {
            animation: correct-animation 0.5s ease-in-out;
        }
        
        /* Estilo para la traducción */
        .translation {
            @apply text-slate-500 italic text-sm pt-0;
        }

        /* Estilos para el modal */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4 antialiased">

    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Actividad de Aprendizaje Intensivo</h1>
            <p class="text-slate-500 mt-2">Práctica de Conversación Detallada</p>
        </header>

        <div class="border-b border-slate-200 mb-6">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs" role="tablist">
                <button id="tab-reconstruye" class="tab-btn active-tab" role="tab" aria-selected="true" aria-controls="panel-reconstruye">Reconstruye</button>
                <button id="tab-adivina" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-adivina">Adivina</button>
                <button id="tab-ordena" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-ordena">Ordena</button>
                <button id="tab-shadowing" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-shadowing">Shadowing</button>
            </nav>
        </div>

        <main>
            <div id="panel-reconstruye" class="tab-content" role="tabpanel" aria-labelledby="tab-reconstruye">
                <h2 class="text-xl font-semibold mb-4 text-center">Reconstrucción del Diálogo</h2>
                <p class="text-center text-slate-600 mb-4">Usa la secuencia de emojis como guía para recordar el flujo de la conversación.</p>
                <div class="bg-slate-50 rounded-lg p-4 mb-4">
                    <p class="font-semibold mb-2 text-center text-slate-700">Guía de Emojis:</p>
                    <div id="reco-emojis" class="text-2xl md:text-3xl text-center tracking-wider leading-relaxed"></div>
                </div>
                <div id="reco-feedback" class="mt-4 p-4 rounded-lg bg-emerald-50 border border-emerald-200 text-left hidden max-h-[450px] overflow-y-auto">
                    <p class="font-semibold text-emerald-800 mb-2">Diálogo Original:</p>
                    <div id="reco-original-text" class="text-emerald-700 mt-1 space-y-3"></div>
                </div>
                <div class="mt-6 flex justify-center">
                    <button id="check-reco-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg transition shadow-md">Revelar Diálogo</button>
                </div>
            </div>
            
            <div id="panel-adivina" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-adivina">
                <h2 class="text-xl font-semibold mb-4 text-center">Adivina la Frase Clave</h2>
                <p class="text-center text-slate-600 mb-6">Haz clic en "Revelar" para descubrir cada frase, su pronunciación y traducción.</p>
                <div id="guess-container" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    </div>
            </div>

            <div id="panel-ordena" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-ordena">
                <h2 class="text-xl font-semibold mb-4 text-center">Ordena la Historia</h2>
                <p class="text-center text-slate-600 mb-4">Arrastra los grupos de emojis en el orden correcto para contar la historia.</p>
                <div class="mb-6">
                    <p class="font-semibold mb-2 text-center text-slate-700">Emojis Desordenados:</p>
                    <div id="drag-source" class="flex flex-wrap justify-center items-center gap-4 p-4 bg-slate-50 rounded-lg min-h-[80px]">
                        </div>
                </div>
                <div>
                    <p class="font-semibold mb-2 text-center text-slate-700">Tu Historia:</p>
                    <div id="drop-zone" class="flex flex-wrap justify-center items-center gap-4 p-4 rounded-lg min-h-[80px] border-2 dashed border-slate-300 transition-all duration-300">
                        </div>
                </div>
                <div id="order-feedback" class="mt-4 h-6 text-lg font-medium text-center transition-colors"></div>
                <div class="mt-6 flex justify-center space-x-4">
                    <button id="check-order-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg transition shadow-md disabled:bg-slate-400 disabled:cursor-not-allowed">Verificar Orden</button>
                    <button id="reset-order-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-md">Reiniciar</button>
                </div>
            </div>

            <!-- Shadowing Panel (moved after Ordena) -->
            <div id="panel-shadowing" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-shadowing">
                <h2 class="text-xl font-semibold mb-4 text-center">Práctica de Shadowing</h2>
                <p class="text-center text-slate-600 mb-6">Selecciona una opción para escuchar el diálogo completo y practicar tu pronunciación.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="shadow-es-slow-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md">
                        Shadowing Español Lento (0.6x)
                    </button>
                    <button id="shadow-es-normal-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md">
                        Shadowing Español Normal (1.0x)
                    </button>
                    <button id="shadow-en-slow-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md">
                        Shadowing Inglés Lento (0.6x)
                    </button>
                    <button id="shadow-en-normal-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md">
                        Shadowing Inglés Normal (1.0x)
                    </button>
                </div>
            </div>
            <!-- End Shadowing Panel -->
        </main>
    </div>

    <!-- Modal Structure for Emoji Details -->
    <div id="emoji-detail-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-modal-btn">&times;</span>
            <div class="text-center mb-4">
                <p id="modal-display-emoji" class="text-4xl mb-2"></p>
                <p id="modal-english-text" class="text-xl font-bold text-sky-700"></p>
                <p id="modal-pronunciation-text" class="text-base text-slate-600"></p>
                <p id="modal-spanish-translation" class="text-base italic text-slate-500 mt-2"></p>
            </div>
            <div class="flex justify-center">
                <button id="play-modal-audio-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md">
                    Reproducir Audio
                </button>
            </div>
        </div>
    </div>

    <script>
        const LearningApp = {
            config: {
                vocabulary: [
                    { emoji: '😬🏠', word: { es: '(Tensión en el Hogar)', en: '<b>Tension in the Home</b> [tén-shon in da houm]' }},
                    { emoji: '👫✉️🍽️👫', word: { es: '(Amy y Ben han sido invitados a cenar por otra pareja.)', en: '<b>Amy and Ben have been invited to dinner by another couple.</b> [éi-mi and ben jav bin in-váit-ed tu dí-ner bai a-ná-der ka-pol]' }},
                    { emoji: '😟🚗💨', word: { es: '(Están un poco nerviosos, y están a punto de ser recogidos.)', en: '<b>They’re a little nervous, and are about to get picked up.</b> [zeir a lí-tol ner-vus, and ar a-baut tu get pikt ap]' }},
                    { emoji: '🗣️❓', word: { es: '(Ben: Amy, ¿qué crees que estás haciendo?)', en: '<strong>Ben:</strong> <b>Amy, what do you think you’re doing?</b> [éi-mi, wat du iu zink iur dú-ing?]' }},
                    { emoji: '🦷🤷‍♀️', word: { es: '(Amy: ¿Qué? Me estoy cepillando los dientes. ¿Qué parece que estoy haciendo?)', en: '<strong>Amy:</strong> <b>What? I’m brushing my teeth. What does it look like I’m doing?</b> [wat? aim brá-shing mai tiz. wat das it luk laik aim dú-ing?]' }},
                    { emoji: '🚫🗣️', word: { es: '(Ben: Bueno, déjalo ya.)', en: '<strong>Ben:</strong> <b>Well, cut it out.</b> [wel, kat it aut]' }},
                    { emoji: '⏰❓📼', word: { es: '(Están a punto de llegar y no puedo averiguar cómo programar tu nueva VCR.)', en: '<b>They’re about to get here and I can’t figure out how to program your new VCR.</b> [zeir a-baut tu get jir and ai cant fí-guer aut jau tu prou-gram iur niu vi-si-ar.]' }},
                    { emoji: '🤝🏃‍♀️', word: { es: '(Ven aquí y ayúdame.)', en: '<b>Get over here and help me.</b> [get ó-ver jir and jelp mi.]' }},
                    { emoji: '🤷‍♀️❓', word: { es: '(Amy: ¿Por qué? No sé cómo usarlo mejor que tú.)', en: '<strong>Amy:</strong> <b>Why? I don’t know how to work it any better than you.</b> [wai? ai dont nou jau tu werk it é-ni bé-ter zan iu.]' }},
                    { emoji: ' 🧠💡', word: { es: '(Ben: Lo sé, pero dos cabezas piensan mejor que una.)', en: '<strong>Ben:</strong> <b>I know, but two heads are better than one.</b> [ai nou, bat tu jedz ar bé-ter zan uan.]' }},
                    { emoji: '💩❓', word: { es: '(Mierda, ¿qué está haciendo?)', en: '<b>Crap, what’s it doing?</b> [crap, wats it dú-ing?]' }},
                    { emoji: '🤦‍♀️👎', word: { es: '(Amy: ¡Lo arruinaste! ¡Dios mío, eres un manazas!)', en: '<strong>Amy:</strong> <b>You messed it up! Oh my gosh, you’re all thumbs!</b> [iu mest it ap! ou mai gosh, iur ol zams!]' }},
                    { emoji: '🤷‍♂️🤔', word: { es: '(Ben: No lo entiendo... Pulsé el botón correcto, debería haber funcionado.)', en: '<strong>Ben:</strong> <b>I don’t get it… I pressed the right button, it should’ve worked.</b> [ai dont get it... ai prest da rait bo-ton, it shud-ev werkt.]' }},
                    { emoji: '🙅‍♀️📺❌', word: { es: '(Amy: Olvidémoslo. Puedes perderte tu programa esta noche.)', en: '<strong>Amy:</strong> <b>Let’s just forget it. You can miss your show tonight.</b> [lets yost for-get it. iu can mis iur shou tu-náit.]' }},
                    { emoji: '🪙🔢', word: { es: '(Son muy comunes de todos modos.)', en: '<b>They’re a dime a dozen anyway.</b> [zeir a daim a dó-sen é-ni-wei.]' }},
                    { emoji: '🗣️➡️🥊', word: { es: '(Ben: Eso es fácil de decir para ti. No me rindo todavía.)', en: '<strong>Ben:</strong> <b>That’s easy for you to say. I’m not throwing in the towel just yet.</b> [zats í-si for iu tu sei. aim not zrou-ing in da táu-el yost yet.]' }},
                    { emoji: '👍⏰🚶‍♀️', word: { es: '(Amy: Bien, solo prepárate a tiempo. Vuelvo enseguida.)', en: '<strong>Amy:</strong> <b>Fine, just be ready on time. I’ll be right back.</b> [fain, yost bi ré-di on taim. ail bi rait bak.]' }},
                    { emoji: '🤷‍♀️🦷📺', word: { es: '(Amy: ¿Por qué te estás cepillando los dientes frente al televisor?)', en: '<strong>Amy:</strong> <b>Why are you brushing your teeth in front of the TV?</b> [wai ar iu brá-shing iur tiz in front of da ti-vi?]' }},
                    { emoji: '🐦🐦🪨', word: { es: '(Ben: Estoy matando dos pájaros de un tiro.)', en: '<strong>Ben:</strong> <b>I’m killing two birds with one stone.</b> [aim kí-ling tu berds wiz uan stoun.]' }},
                    { emoji: '✅📺 grabar', word: { es: '(Casi tengo el programa programado para grabar.)', en: '<b>I’ve almost got the show programmed to record.</b> [aiv ol-most got da shou prou-gramd tu re-cord.]' }},
                    { emoji: '💧🧴⬇️', word: { es: '(Amy: Bueno, estás goteando pasta de dientes en el suelo.)', en: '<strong>Amy:</strong> <b>Well, you’re dripping toothpaste on the floor.</b> [wel, iur drí-ping tuz-peist on da flor.]' }},
                    { emoji: '😬🧼🔙', word: { es: '(Ben: ¡Ups! Podemos limpiarlo cuando volvamos.)', en: '<strong>Ben:</strong> <b>Whoops! We can clean it up when we get back.</b> [wups! wi can klin it ap wen wi get bak.]' }},
                    { emoji: '⏰🏃‍♀️💨', word: { es: '(Más vale tarde que nunca.)', en: '<b>Better late than never.</b> [bé-ter leit zan né-ver.]' }},
                    { emoji: '🤷‍♀️🧹', word: { es: '(Amy: ¿Nosotros? ¡Quieres decir que tú lo limpiarás!)', en: '<strong>Amy:</strong> <b>We? You mean you’ll clean it!</b> [wi? iu min iul klin it!]' }},
                    { emoji: '🙄🤏', word: { es: '(Ben: Oh, supéralo. No es para tanto.)', en: '<strong>Ben:</strong> <b>Oh, get over it. It’s not that big of a deal.</b> [ou, get ó-ver it. its not zat big of a dil.]' }},
                    { emoji: '👋🚗', word: { es: '(Oye, están aquí para recogernos.)', en: '<b>Hey, they’re here to get us.</b> [jei, zeir jir tu get as.]' }},
                    { emoji: '🏃‍♀️💨👀', word: { es: '(Amy: Vamos, démonos prisa y salgamos de aquí antes de que entren y vean el suelo.)', en: '<strong>Amy:</strong> <b>Come on, let’s hurry up and get out of here before they come in and see the floor.</b> [com on, lets já-ri ap and get aut of jir bi-for zei com in and si da flor.]' }}
                ],
                correctSequence: [
                    '😬🏠', '👫✉️🍽️👫', '😟🚗💨', '🗣️❓', '🦷🤷‍♀️', '🚫🗣️', '⏰❓📼', '🤝🏃‍♀️', '🤷‍♀️❓', 
                    '🧠🧠💡', '💩❓', '🤦‍♀️👎', '🤷‍♂️🤔', '🙅‍♀️📺❌', '🪙🔢', '🗣️➡️🥊', '👍⏰🚶‍♀️', 
                    '🤷‍♀️🦷📺', '🐦🐦🪨', '✅📺 grabar', '💧🧴⬇️', '😬🧼🔙', '⏰🏃‍♀️💨', '🤷‍♀️🧹', 
                    '🙄🤏', '👋🚗', '🏃‍♀️💨👀'
                ],
                originalText: `
                    <div><p><strong>Amy and Ben have been invited to dinner by another couple.</strong> [éi-mi and ben jav bin in-váit-ed tu dí-ner bai a-ná-der ka-pol] <b>They’re a little nervous, and are about to get picked up.</b> [zeir a lí-tol ner-vus, and ar a-baut tu get pikt ap]</p><p class="translation">(Amy y Ben han sido invitados a cenar por otra pareja. Están un poco nerviosos, y están a punto de ser recogidos.)</p></div>
                    <div><p><strong>Ben:</strong> <b>Amy, what do you think you’re doing?</b> [éi-mi, wat du iu zink iur dú-ing?]</p><p class="translation">(Ben: Amy, ¿qué crees que estás haciendo?)</p></div>
                    <div><p><strong>Amy:</strong> <b>What? I’m brushing my teeth. What does it look like I’m doing?</b> [wat? aim brá-shing mai tiz. wat das it luk laik aim dú-ing?]</p><p class="translation">(Amy: ¿Qué? Me estoy cepillando los dientes. ¿Qué parece que estoy haciendo?)</p></div>
                    <div><p><strong>Ben:</strong> <b>Well, cut it out. They’re about to get here and I can’t figure out how to program your new VCR. Get over here and help me.</b> [wel, kat it aut. Zeir a-baut tu get jir and ai cant fí-guer aut jau tu prou-gram iur niu vi-si-ar. Get ó-ver jir and jelp mi.]</p><p class="translation">(Ben: Bueno, déjalo ya. Están a punto de llegar y no puedo averiguar cómo programar tu nueva VCR. Ven aquí y ayúdame.)</p></div>
                    <div><p><strong>Amy:</strong> <b>Why? I don’t know how to work it any better than you.</b> [wai? ai dont nou jau tu werk it é-ni bé-ter zan iu.]</p><p class="translation">(Amy: ¿Por qué? No sé cómo usarlo mejor que tú.)</p></div>
                    <div><p><strong>Ben:</strong> <b>I know, but two heads are better than one. Crap, what’s it doing?</b> [ai nou, bat tu jedz ar bé-ter zan uan. Crap, wats it dú-ing?]</p><p class="translation">(Ben: Lo sé, pero dos cabezas piensan mejor que una. Mierda, ¿qué está haciendo?)</p></div>
                    <div><p><strong>Amy:</strong> <b>You messed it up! Oh my gosh, you’re all thumbs!</b> [iu mest it ap! ou mai gosh, iur ol zams!]</p><p class="translation">(Amy: ¡Lo arruinaste! ¡Dios mío, eres un manazas!)</p></div>
                    <div><p><strong>Ben:</strong> <b>I don’t get it… I pressed the right button, it should’ve worked.</b> [ai dont get it... ai prest da rait bo-ton, it shud-ev werkt.]</p><p class="translation">(Ben: No lo entiendo... Pulsé el botón correcto, debería haber funcionado.)</p></div>
                    <div><p><strong>Amy:</strong> <b>Let’s just forget it. You can miss your show tonight. They’re a dime a dozen anyway.</b> [lets yost for-get it. iu can mis iur shou tu-náit. Zeir a daim a dó-sen é-ni-wei.]</p><p class="translation">(Amy: Olvidémoslo. Puedes perderte tu programa esta noche. Son muy comunes de todos modos.)</p></div>
                    <div><p><strong>Ben:</strong> <b>That’s easy for you to say. I’m not throwing in the towel just yet.</b> [zats í-si for iu tu sei. aim not zrou-ing in da táu-el yost yet.]</p><p class="translation">(Ben: Eso es fácil de decir para ti. No me rindo todavía.)</p></div>
                    <div><p><strong>Amy:</strong> <b>Fine, just be ready on time. I’ll be right back.</b> [fain, yost bi ré-di on taim. ail bi rait bak.]</p><p class="translation">(Amy: Bien, solo prepárate a tiempo. Vuelvo enseguida.)</p></div>
                    <div><p><strong>Amy:</strong> <b>Why are you brushing your teeth in front of the TV?</b> [wai ar iu brá-shing iur tiz in front of da ti-vi?]</p><p class="translation">(Amy: ¿Por qué te estás cepillando los dientes frente al televisor?)</p></div>
                    <div><p><strong>Ben:</strong> <b>I’m killing two birds with one stone. I’ve almost got the show programmed to record.</b> [aim kí-ling tu berds wiz uan stoun. Aiv ol-most got da shou prou-gramd tu re-cord.]</p><p class="translation">(Ben: Estoy matando dos pájaros de un tiro. Casi tengo el programa programado para grabar.)</p></div>
                    <div><p><strong>Amy:</strong> <b>Well, you’re dripping toothpaste on the floor.</b> [wel, iur drí-ping tuz-peist on da flor.]</p><p class="translation">(Amy: Bueno, estás goteando pasta de dientes en el suelo.)</p></div>
                    <div><p><strong>Ben:</strong> <b>Whoops! We can clean it up when we get back. Better late than never.</b> [wups! wi can klin it ap wen wi get bak. Bé-ter leit zan né-ver.]</p><p class="translation">(Ben: ¡Ups! Podemos limpiarlo cuando volvamos. Más vale tarde que nunca.)</p></div>
                    <div><p><strong>Amy:</strong> <b>We? You mean you’ll clean it!</b> [wi? iu min iul klin it!]</p><p class="translation">(Amy: ¿Nosotros? ¡Quieres decir que tú lo limpiarás!)</p></div>
                    <div><p><strong>Ben:</strong> <b>Oh, get over it. It’s not that big of a deal. Hey, they’re here to get us.</b> [ou, get ó-ver it. its not zat big of a dil. Jei, zeir jir tu get as.]</p><p class="translation">(Ben: Oh, supéralo. No es para tanto. Oye, están aquí para recogernos.)</p></div>
                    <div><p><strong>Amy:</strong> <b>Come on, let’s hurry up and get out of here before they come in and see the floor.</b> [com on, lets já-ri ap and get aut of jir bi-for zei com in and si da flor.]</p><p class="translation">(Amy: Vamos, démonos prisa y salgamos de aquí antes de que entren y vean el suelo.)</p></div>
                `
            },
            state: { draggedElement: null, currentAudioText: '', lastDoubleClickedElement: null }, 
            elements: {},

            init() {
                this.cacheDomElements();
                this.bindEvents();
                this.renderAllActivities();
            },

            cacheDomElements() {
                this.elements.tabButtons = document.querySelectorAll('.tab-btn');
                this.elements.tabPanels = document.querySelectorAll('.tab-content');
                this.elements.guessContainer = document.getElementById('guess-container');
                this.elements.dragSource = document.getElementById('drag-source');
                this.elements.dropZone = document.getElementById('drop-zone');
                this.elements.orderFeedback = document.getElementById('order-feedback');
                this.elements.checkOrderBtn = document.getElementById('check-order-btn');
                this.elements.resetOrderBtn = document.getElementById('reset-order-btn');
                this.elements.recoEmojis = document.getElementById('reco-emojis');
                this.elements.recoFeedback = document.getElementById('reco-feedback');
                this.elements.recoOriginalText = document.getElementById('reco-original-text');
                this.elements.checkRecoBtn = document.getElementById('check-reco-btn');

                // Modal Elements for "Ordena" section
                this.elements.emojiDetailModal = document.getElementById('emoji-detail-modal');
                this.elements.closeModalBtn = document.getElementById('close-modal-btn');
                this.elements.modalDisplayEmoji = document.getElementById('modal-display-emoji');
                this.elements.modalEnglishText = document.getElementById('modal-english-text');
                this.elements.modalPronunciationText = document.getElementById('modal-pronunciation-text');
                this.elements.modalSpanishTranslation = document.getElementById('modal-spanish-translation');
                this.elements.playModalAudioBtn = document.getElementById('play-modal-audio-btn');

                // Shadowing elements
                this.elements.tabShadowing = document.getElementById('tab-shadowing');
                this.elements.shadowEsSlowBtn = document.getElementById('shadow-es-slow-btn');
                this.elements.shadowEsNormalBtn = document.getElementById('shadow-es-normal-btn');
                this.elements.shadowEnSlowBtn = document.getElementById('shadow-en-slow-btn');
                this.elements.shadowEnNormalBtn = document.getElementById('shadow-en-normal-btn');
            },

            bindEvents() {
                this.elements.tabButtons.forEach(button => button.addEventListener('click', (e) => this.changeTab(e)));
                this.elements.guessContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('reveal-btn')) {
                        this.toggleAnswer(e.target);
                    }
                });
                this.elements.checkOrderBtn.addEventListener('click', () => this.checkOrder());
                this.elements.resetOrderBtn.addEventListener('click', () => this.renderOrderGame());
                this.elements.checkRecoBtn.addEventListener('click', () => this.toggleRecoFeedback());

                // Bind modal close and audio play events
                this.elements.closeModalBtn.addEventListener('click', () => this.hideEmojiDetailsModal());
                this.elements.emojiDetailModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.emojiDetailModal) {
                        this.hideEmojiDetailsModal();
                    }
                });
                this.elements.playModalAudioBtn.addEventListener('click', () => this.playTextAudio(this.state.currentAudioText, 'en-US', 1.0)); // Modal always plays English normal

                // Shadowing button event listeners
                this.elements.shadowEsSlowBtn.addEventListener('click', () => this.playShadowingAudio('es', 0.6));
                this.elements.shadowEsNormalBtn.addEventListener('click', () => this.playShadowingAudio('es', 1.0));
                this.elements.shadowEnSlowBtn.addEventListener('click', () => this.playShadowingAudio('en', 0.6));
                this.elements.shadowEnNormalBtn.addEventListener('click', () => this.playShadowingAudio('en', 1.0));

                // Initial binding for drag and drop (will be re-applied in renderOrderGame)
                this.bindDragAndDropEvents();
            },

            renderAllActivities() {
                this.renderRecoGame();
                this.renderGuessGame();
                this.renderOrderGame();
            },

            changeTab(event) {
                const clickedTab = event.currentTarget;
                const targetPanelId = clickedTab.getAttribute('aria-controls');

                this.elements.tabPanels.forEach(panel => panel.classList.add('hidden'));
                this.elements.tabButtons.forEach(btn => {
                    btn.classList.remove('active-tab');
                    btn.setAttribute('aria-selected', 'false');
                });

                document.getElementById(targetPanelId).classList.remove('hidden');
                clickedTab.classList.add('active-tab');
                clickedTab.setAttribute('aria-selected', 'true');
            },

            renderRecoGame() {
                this.elements.recoEmojis.textContent = this.config.correctSequence.join(' ');
                this.elements.recoOriginalText.innerHTML = this.config.originalText;
                this.elements.recoFeedback.classList.add('hidden');
                this.elements.checkRecoBtn.textContent = 'Revelar Diálogo';
            },

            toggleRecoFeedback() {
                const isHidden = this.elements.recoFeedback.classList.toggle('hidden');
                this.elements.checkRecoBtn.textContent = isHidden ? 'Revelar Diálogo' : 'Ocultar Diálogo';
            },

            renderGuessGame() {
                this.elements.guessContainer.innerHTML = '';
                this.config.vocabulary.forEach(item => {
                    const wordEl = document.createElement('div');
                    wordEl.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg shadow-sm';
                    const bilingualText = `${item.word.en}<br><span class="text-slate-500 font-normal">${item.word.es}</span>`;
                    wordEl.innerHTML = `
                        <span class="text-2xl md:text-3xl">${item.emoji}</span>
                        <div class="text-right flex-1 ml-4">
                            <p class="answer-text hidden text-base md:text-lg font-semibold text-sky-700 mb-1">${bilingualText}</p>
                            <button class="reveal-btn bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-3 rounded-full transition shadow">Revelar</button>
                        </div>`;
                    this.elements.guessContainer.appendChild(wordEl);
                });
            },

            toggleAnswer(button) {
                const answerP = button.previousElementSibling;
                const isHidden = answerP.classList.toggle('hidden');
                button.textContent = isHidden ? 'Revelar' : 'Ocultar';
            },

            shuffleArray(array) {
                return [...array].sort(() => Math.random() - 0.5);
            },

            renderOrderGame() {
                this.elements.dragSource.innerHTML = '';
                this.elements.dropZone.innerHTML = '';
                this.elements.orderFeedback.textContent = '';
                this.elements.checkOrderBtn.disabled = true;

                const shuffledEmojis = this.shuffleArray(this.config.correctSequence);
                shuffledEmojis.forEach(emoji => {
                    const emojiEl = document.createElement('div');
                    emojiEl.textContent = emoji;
                    emojiEl.className = 'text-2xl md:text-3xl cursor-grab p-2 bg-white rounded-md shadow-sm transition-transform';
                    emojiEl.draggable = true;
                    // Store the emoji in a data attribute for easy lookup
                    emojiEl.setAttribute('data-emoji', emoji); 
                    this.elements.dragSource.appendChild(emojiEl);
                });

                // Re-apply event listeners after rendering new elements
                this.addDragListenersToItems();
                this.addDoubleClickListenersToOrderItems();
            },

            bindDragAndDropEvents() {
                const dropZones = [this.elements.dropZone, this.elements.dragSource];
                dropZones.forEach(zone => {
                    zone.addEventListener('dragover', e => {
                        e.preventDefault();
                        if (zone.id === 'drop-zone') zone.classList.add('drag-over');
                    });
                    zone.addEventListener('dragleave', e => {
                        if (zone.id === 'drop-zone') zone.classList.remove('drag-over');
                    });
                    zone.addEventListener('drop', e => {
                        e.preventDefault();
                        if (this.state.draggedElement) {
                            zone.appendChild(this.state.draggedElement);
                            // Re-attach double-click listeners after a drop
                            this.addDoubleClickListenersToOrderItems(); 
                        }
                        if (zone.id === 'drop-zone') zone.classList.remove('drag-over');
                        this.updateCheckButtonState();
                    });
                });
            },

            addDragListenersToItems() {
                 document.querySelectorAll('#drag-source div, #drop-zone div').forEach(item => {
                    item.addEventListener('dragstart', e => {
                        this.state.draggedElement = e.target;
                        setTimeout(() => e.target.classList.add('dragging'), 0);
                    });
                    item.addEventListener('dragend', e => {
                        e.target.classList.remove('dragging');
                        this.state.draggedElement = null;
                    });
                });
            },

            // Function to add double-click listeners specifically for "Ordena" items
            addDoubleClickListenersToOrderItems() {
                document.querySelectorAll('#drag-source div, #drop-zone div').forEach(item => {
                    // Remove existing listener to prevent duplicates if elements are re-rendered/moved
                    item.removeEventListener('dblclick', this.handleOrderItemDoubleClick);
                    // Add new listener, binding 'this' to the LearningApp object
                    item.addEventListener('dblclick', this.handleOrderItemDoubleClick.bind(this));
                });
            },

            handleOrderItemDoubleClick(event) {
                // Store the element that was double-clicked
                this.state.lastDoubleClickedElement = event.target;
                const emoji = event.target.getAttribute('data-emoji');
                if (emoji) {
                    this.showEmojiDetailsModal(emoji);
                }
            },

            showEmojiDetailsModal(emoji) {
                const item = this.config.vocabulary.find(vocab => vocab.emoji === emoji);
                if (item) {
                    this.elements.modalDisplayEmoji.textContent = item.emoji;

                    // Extract English text and pronunciation
                    const englishTextWithPronunciation = item.word.en;
                    const regex = /<b>(.*?)<\/b>\s*\[(.*?)\]/;
                    const match = englishTextWithPronunciation.match(regex);

                    let englishText = englishTextWithPronunciation.replace(/<[^>]*>/g, '').trim(); // Default, remove HTML tags
                    let pronunciation = '';

                    if (match && match[1] && match[2]) {
                        englishText = match[1];
                        pronunciation = `[${match[2]}]`;
                    } else {
                        // Fallback if the regex doesn't match the expected format
                        const boldTextMatch = englishTextWithPronunciation.match(/<b>(.*?)<\/b>/);
                        if(boldTextMatch && boldTextMatch[1]) englishText = boldTextMatch[1];

                        const bracketTextMatch = englishTextWithPronunciation.match(/\[(.*?)\]/);
                        if(bracketTextMatch && bracketTextMatch[1]) pronunciation = `[${bracketTextMatch[1]}]`;
                    }
                    
                    this.elements.modalEnglishText.textContent = englishText;
                    this.elements.modalPronunciationText.textContent = pronunciation;
                    this.elements.modalSpanishTranslation.textContent = item.word.es;
                    this.elements.emojiDetailModal.classList.remove('hidden');

                    // Store the clean English text for audio playback
                    this.state.currentAudioText = englishText; 
                    
                    // Automatically play audio when modal opens
                    this.playTextAudio(this.state.currentAudioText, 'en-US', 1.0); // Play English normal speed
                }
            },

            hideEmojiDetailsModal() {
                this.elements.emojiDetailModal.classList.add('hidden');
                // Stop any ongoing speech when closing the modal
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }

                // Move the element if it was double-clicked
                if (this.state.lastDoubleClickedElement) {
                    const clickedElement = this.state.lastDoubleClickedElement;
                    const currentParent = clickedElement.parentNode;

                    if (currentParent === this.elements.dragSource) {
                        // If it was in Emojis Desordenados, move to Tu Historia
                        this.elements.dropZone.appendChild(clickedElement);
                    } else if (currentParent === this.elements.dropZone) {
                        // If it was in Tu Historia, move to Emojis Desordenados
                        this.elements.dragSource.appendChild(clickedElement);
                    }
                    // Clear the stored element after moving
                    this.state.lastDoubleClickedElement = null; 
                    this.updateCheckButtonState(); // Update button state after move
                    this.addDoubleClickListenersToOrderItems(); // Re-add listeners after moving
                }
            },

            playTextAudio(text, lang = 'en-US', rate = 1.0) {
                if ('speechSynthesis' in window) {
                    // Cancel any ongoing speech before starting a new one
                    if (window.speechSynthesis.speaking) {
                        window.speechSynthesis.cancel();
                    }
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang; 
                    utterance.volume = 1; 
                    utterance.rate = rate; 
                    utterance.pitch = 1; 
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Tu navegador no soporta la síntesis de voz.');
                }
            },

            // Function to handle Shadowing audio playback
            playShadowingAudio(langCode, rate) {
                let fullText = '';
                const parser = new DOMParser();
                const doc = parser.parseFromString(this.config.originalText, 'text/html');
                const divs = doc.querySelectorAll('body > div'); // Select direct child divs

                divs.forEach(div => {
                    if (langCode === 'en') {
                        const englishParagraph = div.querySelector('p:not(.translation)');
                        if (englishParagraph) {
                            let text = englishParagraph.textContent || '';
                            // Remove pronunciation part like [Jé-lou]
                            text = text.replace(/\[.*?\]/g, '').trim();
                            // Remove speaker names like "Tanya:" or "Angela:"
                            text = text.replace(/^(<strong>)?(Amy|Ben):\s*/i, '').trim(); // Updated speaker names for Amy/Ben
                            fullText += text + ' ';
                        }
                    } else if (langCode === 'es') {
                        const spanishParagraph = div.querySelector('p.translation');
                        if (spanishParagraph) {
                            let text = spanishParagraph.textContent || '';
                            // Remove parentheses like (Hola.)
                            text = text.replace(/\(|\)/g, '').trim();
                            fullText += text + ' ';
                        }
                    }
                });

                // Determine the correct language tag for SpeechSynthesis
                let speechLang = '';
                if (langCode === 'en') {
                    speechLang = 'en-US';
                } else if (langCode === 'es') {
                    speechLang = 'es-ES';
                }

                if (fullText.trim()) {
                    this.playTextAudio(fullText.trim(), speechLang, rate);
                } else {
                    alert('No se pudo extraer el texto para la reproducción de audio.');
                }
            },

            updateCheckButtonState() {
                this.elements.checkOrderBtn.disabled = this.elements.dropZone.children.length === 0;
            },

            checkOrder() {
                const userSequence = Array.from(this.elements.dropZone.children).map(el => el.textContent);
                this.elements.orderFeedback.classList.remove('correct');
                // Trigger reflow to restart animation
                void this.elements.orderFeedback.offsetWidth; 

                if (JSON.stringify(userSequence) === JSON.stringify(this.config.correctSequence)) {
                    this.elements.orderFeedback.textContent = '¡Historia Perfecta!  ';
                    this.elements.orderFeedback.className = 'mt-4 h-6 text-lg font-medium text-center text-green-600 correct';
                } else {
                    this.elements.orderFeedback.textContent = 'El orden no es correcto. ¡Sigue intentando!';
                    this.elements.orderFeedback.className = 'mt-4 h-6 text-lg font-medium text-center text-red-500';
                }
            }
        };

        window.addEventListener('load', () => LearningApp.init());
    </script>
</body>
</html>