<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguridad-Tratamiento-Etica</title>
    <!-- Carga de Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #1a202c; /* bg-gray-900 */
        }
        /* Estilos personalizados para la barra de desplazamiento (Webkit) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* bg-gray-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #2d3748; /* bg-gray-800 */
        }
    </style>
</head>
<body class="text-gray-300 min-h-screen p-2 sm:p-4">

    <!-- Contenedor Principal del Quiz -->
    <div id="quiz-container" class="max-w-5xl mx-auto space-y-4">

        <!-- Cabecera Consolidada (Título, Contadores y Temporizador) -->
        <header id="quiz-header" class="bg-gray-800 p-3 rounded-2xl shadow-lg flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 text-sm">
            <!-- Título Principal -->
            <h1 class="text-xl font-bold text-blue-400">Seguridad-Tratamiento-Ética</h1>
            
            <!-- Contadores e Indicadores -->
            <div class="flex flex-wrap justify-center sm:justify-end items-center space-x-4">
                <div class="flex items-center space-x-1">
                    <span class="text-green-400 font-semibold">Correctas:</span>
                    <span id="correct-count" class="font-bold">0</span>
                </div>
                <div class="flex items-center space-x-1">
                    <span class="text-red-400 font-semibold">Incorrectas:</span>
                    <span id="incorrect-count" class="font-bold">0</span>
                </div>
                <div class="flex items-center space-x-1">
                    <span class="text-yellow-400 font-semibold">Racha:</span>
                    <span id="streak-count" class="font-bold">0</span>
                </div>
                <!-- Temporizador -->
                <div class="flex items-center space-x-1 bg-gray-700 py-1 px-3 rounded-full">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="timer-display" class="font-bold text-purple-400">60s</span>
                </div>
            </div>
        </header>

        <!-- Barra de Progreso y Contador de Preguntas -->
        <div id="progress-bar-container" class="p-3 bg-gray-800 rounded-lg shadow-md">
            <p id="question-counter-text" class="text-center text-sm mb-2 text-gray-400">Pregunta 1 de 3</p>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Área de Contenido Dinámico (Quiz o Resultados) -->
        <div id="main-content" class="bg-gray-800 p-6 rounded-2xl shadow-xl min-h-[300px]">
            <!-- Aquí se cargará el quiz o los resultados -->
            <p class="text-center text-xl text-blue-400">Cargando Quiz...</p>
        </div>

    </div>

    <script type="text/javascript">
        // El contenido del quiz (preguntas, opciones, respuestas y justificaciones)
        // Estrictamente según las fuentes proporcionadas por el usuario.
        const allQuizData = [
            {
                "id": 1,
                "questionText": "La nefropatía obstructiva se determina como",
                "options": [
                    { "text": "presencia de daño estructural", "correct": false },
                    { "text": "Presencia de daño funcional", "correct": false },
                    { "text": "a y b", "correct": true },
                    { "text": "Ninguna de las anteriores", "correct": false }
                ],
                "justification": "La nefropatía obstructiva implica tanto la presencia de daño estructural (hidronefrosis o cambios parenquimales) como la alteración funcional (disminución de la TFG o alteración de la concentración).",
            },
            {
                "id": 2,
                "questionText": "La uropatía obstructiva es causal de la nefropatía obstructiva?",
                "options": [
                    { "text": "Verdadero", "correct": true },
                    { "text": "Falso", "correct": false },
                    { "text": "a o b", "correct": false },
                    { "text": "Ninguna de las anteriores", "correct": false }
                ],
                "justification": "Verdadero. La uropatía obstructiva (bloqueo del flujo urinario) es la causa subyacente que conduce al daño renal, o nefropatía obstructiva.",
            },
            {
                "id": 3,
                "questionText": "El estudio ideal imagenológico en la valoración de la nefropatía u uropatía obstructiva es:",
                "options": [
                    { "text": "Ecografia renal", "correct": false },
                    { "text": "Tomografia", "correct": false },
                    { "text": "Radiografia", "correct": false },
                    { "text": "A y b", "correct": true }
                ],
                "justification": "La ecografía renal es el estudio de primera línea para detectar hidronefrosis (daño estructural), y la Tomografía (especialmente la uro-TC) es excelente para determinar la ubicación y causa de la obstrucción.",
            }
        ];

        // --- Estado Global del Quiz ---
        let shuffledQuizData = []; // Array para el orden aleatorio de las preguntas
        let currentQuestionIndex = 0;
        let correctCount = 0; // PC (Preguntas Correctas)
        let incorrectCount = 0; // PI (Preguntas Incorrectas, erradas al menos 1 vez)
        let currentStreak = 0;
        let maxStreak = 0;
        let timerInterval;
        const totalTime = 60; // Segundos por pregunta
        let timeLeft = totalTime;

        // Estado para rastrear el progreso y los intentos por pregunta
        // { questionId: 1, attempts: 0, wasAnsweredCorrectly: false, wasIncorrectlyAttempted: false }
        let quizState = []; 

        const mainContent = document.getElementById('main-content');
        
        // --- Funciones de Utilidad ---

        /**
         * Función Fisher-Yates para barajar un array.
         * @param {Array} array El array a barajar.
         * @returns {Array} El array barajado.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Inicializa y prepara los datos del quiz.
         */
        function initializeQuiz() {
            // Barajar el orden de las preguntas
            shuffledQuizData = shuffleArray([...allQuizData]);
            
            // Inicializar el estado de cada pregunta para el seguimiento de la puntuación
            quizState = shuffledQuizData.map(q => ({
                id: q.id,
                attempts: 0,
                wasAnsweredCorrectly: false,
                wasIncorrectlyAttempted: false,
                initialOrder: allQuizData.findIndex(data => data.id === q.id) + 1, // Para el resumen final
            }));
            
            // Resetear contadores
            currentQuestionIndex = 0;
            correctCount = 0;
            incorrectCount = 0;
            currentStreak = 0;
            maxStreak = 0;
            
            updateHeader();
            renderCurrentQuestion();
            document.getElementById('quiz-header').classList.remove('hidden');
            document.getElementById('progress-bar-container').classList.remove('hidden');
        }

        /**
         * Actualiza los contadores en la cabecera.
         */
        function updateHeader() {
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('incorrect-count').textContent = incorrectCount;
            document.getElementById('streak-count').textContent = currentStreak;

            const totalQuestions = shuffledQuizData.length;
            const currentNumber = currentQuestionIndex + 1;
            
            // Actualizar texto y barra de progreso
            document.getElementById('question-counter-text').textContent = `Pregunta ${currentNumber} de ${totalQuestions}`;
            const progress = (currentNumber / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }
        
        // --- Lógica del Temporizador ---

        /**
         * Detiene y reinicia el temporizador.
         */
        function resetTimer() {
            clearInterval(timerInterval);
            timeLeft = totalTime;
            document.getElementById('timer-display').textContent = `${timeLeft}s`;
            document.getElementById('timer-display').classList.remove('text-red-500');
        }

        /**
         * Inicia el temporizador de cuenta regresiva.
         */
        function startTimer() {
            resetTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-display').textContent = `${timeLeft}s`;

                if (timeLeft <= 10) {
                    document.getElementById('timer-display').classList.add('text-red-500');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        /**
         * Maneja el evento de tiempo agotado (funciona como un intento incorrecto forzado).
         */
        function handleTimeout() {
            clearInterval(timerInterval); // Asegurar que se detiene
            
            const currentState = quizState[currentQuestionIndex];
            
            // Marcar como un intento fallido
            currentState.attempts++;
            
            // Si el intento por timeout es el primero (y único)
            if (!currentState.wasAnsweredCorrectly) {
                // Incrementar PI solo si es la primera vez que se falla
                if (!currentState.wasIncorrectlyAttempted) {
                    incorrectCount++;
                    currentState.wasIncorrectlyAttempted = true;
                }
                
                // Reiniciar Racha por tiempo agotado
                currentStreak = 0;
            }
            
            updateHeader();

            // Deshabilitar todas las opciones y mostrar la justificación
            const optionsContainer = document.getElementById('options-container');
            const allOptions = optionsContainer.querySelectorAll('.option-btn');
            
            allOptions.forEach(btn => {
                const isCorrect = btn.dataset.correct === 'true';
                btn.disabled = true;
                btn.classList.remove('hover:bg-gray-600');
                
                if (isCorrect) {
                    // Resaltar la respuesta correcta en verde (indicando la correcta)
                    btn.classList.add('bg-green-600', 'ring-2', 'ring-green-400');
                } else {
                    // Marcar las opciones no seleccionadas (incorrectas) como deshabilitadas
                    btn.classList.add('bg-gray-700', 'opacity-70');
                }
            });
            
            // Ya no mostramos la justificación textualmente.
            
            // Activar botón Siguiente Pregunta y Terminar
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');

            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-600');
            nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            finishBtn.classList.remove('hidden');
        }


        // --- Renderizado y Lógica del Quiz ---

        /**
         * Renderiza la pregunta actual en la interfaz.
         */
        function renderCurrentQuestion() {
            if (currentQuestionIndex >= shuffledQuizData.length) {
                renderResults();
                return;
            }

            const questionData = shuffledQuizData[currentQuestionIndex];
            
            resetTimer();
            startTimer();
            updateHeader();

            // 1. Contenido base
            // **Se ha eliminado el área de justificación de esta estructura**
            mainContent.innerHTML = `
                <!-- Sección de la Pregunta -->
                <div id="question-section" class="custom-scrollbar max-h-[calc(100vh-220px)] overflow-y-auto pr-2">
                    <p class="text-lg sm:text-xl font-medium mb-6 text-gray-100">${questionData.questionText}</p>
                    
                    <!-- Opciones de Respuesta -->
                    <div id="options-container" class="space-y-3">
                        <!-- Las opciones se inyectan aquí -->
                    </div>
                </div>

                <!-- Controles de Navegación -->
                <div class="mt-8 flex justify-between space-x-4">
                    <button id="next-btn" disabled class="flex-1 py-3 px-6 rounded-xl text-white font-bold transition-all duration-300 bg-gray-600 opacity-50 cursor-not-allowed hover:bg-gray-600/80">
                        Siguiente Pregunta
                    </button>
                    <button id="finish-btn" class="hidden py-3 px-6 rounded-xl text-red-100 font-bold transition-all duration-300 bg-red-800 hover:bg-red-700">
                        Terminar
                    </button>
                </div>
            `;

            // 2. Inyectar Opciones Barajadas
            const optionsContainer = document.getElementById('options-container');
            const shuffledOptions = shuffleArray([...questionData.options]);
            
            shuffledOptions.forEach((option, index) => {
                // Crear el botón de opción
                const btn = document.createElement('button');
                btn.className = `option-btn w-full text-left py-3 px-4 rounded-xl shadow-md transition-all duration-200 
                                 bg-gray-700 hover:bg-gray-600 border border-gray-600`;
                btn.textContent = `${String.fromCharCode(65 + index)}. ${option.text}`; // A, B, C, D...
                btn.dataset.correct = option.correct;
                btn.dataset.index = index;
                btn.addEventListener('click', () => handleOptionClick(btn));
                optionsContainer.appendChild(btn);
            });
            
            // 3. Añadir Listeners a Controles
            document.getElementById('next-btn').addEventListener('click', () => {
                currentQuestionIndex++;
                renderCurrentQuestion();
            });
            document.getElementById('finish-btn').addEventListener('click', renderResults);
        }

        /**
         * Maneja el clic en una opción de respuesta (ahora un solo intento).
         * @param {HTMLElement} selectedButton El botón de opción seleccionado.
         */
        function handleOptionClick(selectedButton) {
            clearInterval(timerInterval); // Detener el temporizador
            const isCorrect = selectedButton.dataset.correct === 'true';
            const currentState = quizState[currentQuestionIndex];
            
            // Siempre se registra un intento (que será el único)
            currentState.attempts++;

            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');
            const allOptions = document.getElementById('options-container').querySelectorAll('.option-btn');

            // --- 1. Lógica de Retroalimentación Visual (Un solo intento) ---
            
            // Deshabilitar TODAS las opciones inmediatamente
            allOptions.forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-gray-600');
            });

            // Resaltar la selección
            selectedButton.classList.add('ring-2');

            // --- 2. Lógica de Puntuación (PC, PI, Racha) ---
            if (isCorrect) {
                // Acierto
                selectedButton.classList.add('bg-green-600', 'ring-green-400');
                
                // Actualizar PC, Racha, y estado
                if (!currentState.wasAnsweredCorrectly) {
                    correctCount++;
                    currentState.wasAnsweredCorrectly = true;
                }
                currentStreak++;
                maxStreak = Math.max(maxStreak, currentStreak);
                
            } else {
                // Fallo
                selectedButton.classList.add('bg-red-600', 'ring-red-400');
                
                // Encontrar y resaltar la respuesta CORRECTA
                let correctButton = null;
                allOptions.forEach(btn => {
                    if (btn.dataset.correct === 'true') {
                        correctButton = btn;
                        // Resaltar la correcta en verde semi-transparente
                        correctButton.classList.add('bg-green-700/50', 'ring-2', 'ring-green-500/50');
                    }
                });

                // Actualizar PI y Racha
                currentStreak = 0;
                if (!currentState.wasIncorrectlyAttempted) {
                    incorrectCount++; 
                    currentState.wasIncorrectlyAttempted = true;
                }
            }

            // 3. Activar botones de avance
            // La justificación ya no se muestra
            
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-600');
            nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            finishBtn.classList.remove('hidden');

            updateHeader();
        }

        /**
         * Muestra la pantalla de resultados finales.
         */
        function renderResults() {
            clearInterval(timerInterval);
            document.getElementById('quiz-header').classList.add('hidden');
            document.getElementById('progress-bar-container').classList.add('hidden');

            // Ordenar el estado de las preguntas por número de intentos (menor a mayor)
            // Aunque ahora solo hay 1 intento, se mantiene por si el estado global se reutiliza.
            const sortedState = quizState.sort((a, b) => a.attempts - b.attempts);
            
            const totalQuestions = shuffledQuizData.length;
            const percentage = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : 0;
            const passed = percentage >= 70; // Criterio de aprobación simple
            const statusColor = passed ? 'text-green-400' : 'text-red-400';

            // Generar la lista de resumen de intentos
            const attemptsListHTML = sortedState.map(state => {
                const questionData = allQuizData.find(q => q.id === state.id);
                const statusIcon = state.wasAnsweredCorrectly ? '✔' : '✖';
                const statusClass = state.wasAnsweredCorrectly ? 'text-green-500' : 'text-red-500';
                
                return `
                    <li class="p-3 bg-gray-700/50 rounded-lg flex justify-between items-center transition-all duration-150 hover:bg-gray-700">
                        <span class="text-sm sm:text-base text-gray-300 line-clamp-1">
                            P${state.initialOrder}: ${questionData.questionText}
                        </span>
                        <div class="flex items-center space-x-3 font-mono">
                            <span class="font-bold ${statusClass}">${statusIcon}</span>
                            <span class="text-xs sm:text-sm text-gray-400">Intentos: ${state.attempts}</span>
                        </div>
                    </li>
                `;
            }).join('');

            mainContent.innerHTML = `
                <div class="text-center space-y-6">
                    <h2 class="text-4xl font-extrabold ${statusColor}">¡Quiz Finalizado!</h2>
                    <p class="text-lg text-gray-400">Tu desempeño en el simulacro de ${totalQuestions} preguntas.</p>
                    
                    <!-- Resumen de Puntuación -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 bg-gray-900 p-5 rounded-xl shadow-2xl border border-gray-700">
                        <div class="p-4 rounded-xl bg-green-900/50">
                            <p class="text-2xl font-bold text-green-400">${correctCount}</p>
                            <p class="text-sm text-gray-400">Preguntas Correctas</p>
                        </div>
                        <div class="p-4 rounded-xl bg-red-900/50">
                            <p class="text-2xl font-bold text-red-400">${incorrectCount}</p>
                            <p class="text-sm text-gray-400">Preguntas Falladas</p>
                        </div>
                        <div class="p-4 rounded-xl bg-yellow-900/50">
                            <p class="text-2xl font-bold text-yellow-400">${maxStreak}</p>
                            <p class="text-sm text-gray-400">Racha Máxima</p>
                        </div>
                    </div>
                    
                    <p class="text-xl font-bold mt-6 ${statusColor}">Puntaje Total: ${percentage}%</p>

                    <!-- Detalle de Intentos -->
                    <div class="mt-8 text-left">
                        <h3 class="text-xl font-semibold text-blue-400 mb-4 border-b border-gray-700 pb-2">Resumen por Pregunta (Ordenado por Intentos)</h3>
                        <ul class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                            ${attemptsListHTML}
                        </ul>
                    </div>

                    <!-- Mensaje Finalizado (No Reiniciable) -->
                    <button disabled class="mt-8 w-full sm:w-1/2 mx-auto py-4 rounded-xl text-white font-bold text-lg bg-gray-600 opacity-70 cursor-not-allowed shadow-xl">
                        Cuestionario Finalizado
                    </button>
                </div>
            `;
        }

        // --- Inicialización del Quiz al cargar la página ---
        document.addEventListener('DOMContentLoaded', initializeQuiz);

    </script>
</body>
</html>
